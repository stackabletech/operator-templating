# =============
# This file is automatically generated from the templates in stackabletech/operator-templating
# DON'T MANUALLY EDIT THIS FILE
# =============
# We want to automatically use the latest. We also don't tag our images with a version.
# hadolint ignore=DL3007
FROM oci.stackable.tech/sdp/ubi9-rust-builder:latest AS builder

# We want to automatically use the latest.
# hadolint ignore=DL3007
FROM registry.access.redhat.com/ubi9/ubi-minimal:latest AS operator

ARG VERSION
ARG RELEASE="1"

LABEL name="Stackable Operator for {[ operator.pretty_string }]" \
  maintainer="info@stackable.tech" \
  vendor="Stackable GmbH" \
  version="${VERSION}" \
  release="${RELEASE}" \
  summary="Deploy and manage {[ operator.pretty_string }] clusters." \
  description="Deploy and manage {[ operator.pretty_string }] clusters."

# Update image and install kerberos client libraries
# install_weak_deps in microdnf does not support the literal "False" as dnf does
# https://github.com/rpm-software-management/microdnf/blob/a600c62f29262d71a6259b70dc220df65a2ab9b5/dnf/dnf-main.c#L176-L189
# NOTE (@NickLarsenNZ): Maybe we should consider pinning package versions?
# hadolint ignore=DL3041
RUN microdnf update -y --setopt=install_weak_deps=0 \
    && microdnf install -y --setopt=install_weak_deps=0 \
      krb5-libs \
      libkadm5 \
    && microdnf clean all \
    && rm -rf /var/cache/yum

COPY LICENSE /licenses/LICENSE

COPY --from=builder /app/* /usr/local/bin/
# {[% if operator.include_productconfig is undefined or operator.include_productconfig == true %}]
COPY deploy/config-spec/properties.yaml /etc/stackable/{[operator.name}]/config-spec/properties.yaml
# {[% endif %}]

RUN groupadd -g 1000 stackable && adduser -u 1000 -g stackable -c 'Stackable Operator' stackable

USER stackable:stackable

ENTRYPOINT ["stackable-{[ operator.name }]"]
CMD ["run"]
